# 自动二次登录插件 (AutoReloginPlugin)

该插件用于保持微信机器人的长时间在线状态，通过定期执行二次登录来刷新会话，防止因会话过期而掉线。

## 功能特点

1. **定期二次登录**：每 2 小时自动执行一次二次登录，刷新会话状态
2. **登录状态监控**：每 5 分钟检查一次登录状态，确保机器人保持在线
3. **自动数据同步**：二次登录成功后自动执行 Newinit 初始化，同步最新数据
4. **异常处理机制**：网络波动时自动重试，确保二次登录的可靠性
5. **完整重新登录**：当二次登录多次失败时，自动尝试完整重新登录

## 安装方法

1. 将整个`AutoReloginPlugin`文件夹复制到`plugins`目录下
2. 重启机器人或在运行时启用插件

## 配置参数

插件提供了以下可配置参数：

- `relogin_interval`：二次登录间隔时间（秒），默认为 7200 秒（2 小时）
- `max_retry_count`：二次登录失败时的最大重试次数，默认为 3 次
- `retry_interval`：重试间隔时间（秒），默认为 60 秒

## 使用方法

插件会在启用后自动运行，无需额外操作。如果需要手动调整参数，可以在机器人启动脚本中添加以下代码：

```python
# 获取插件实例
auto_relogin_plugin = bot.get_plugin("AutoReloginPlugin")
if auto_relogin_plugin:
    # 修改配置参数
    auto_relogin_plugin.relogin_interval = 3600  # 修改为1小时执行一次
    auto_relogin_plugin.max_retry_count = 5  # 修改最大重试次数为5次
```

## 日志说明

插件会在日志中输出以下信息：

- 定期二次登录的执行情况
- 登录状态检查结果
- 二次登录失败时的重试情况
- 完整重新登录的执行情况

## 注意事项

1. 该插件依赖于微信协议的二次登录机制，确保您的协议版本支持二次登录
2. 插件会定期调用 API 接口，可能会增加服务器负担，请根据实际情况调整二次登录的频率
3. 如果遇到频繁掉线问题，可以尝试减少二次登录的间隔时间
4. 插件支持多种协议版本（849、855、iPad 等），会自动根据协议版本选择正确的 API 路径和同步方法

## 原理说明

插件通过调用微信协议的`/Login/TwiceAutoAuth`接口实现二次登录，该接口使用之前保存的 AutoAuthKey 进行快速重新登录，无需再次输入账号密码或进行完整的身份验证。二次登录成功后，会根据协议版本选择不同的数据同步方法：

- **849 协议**：调用`/VXAPI/Login/Newinit`接口进行数据同步
- **855/iPad 等协议**：调用`/api/Login/Newinit`接口或使用`sync_message`方法进行数据同步

这种智能适配机制确保了插件能够在不同协议版本下正常工作，无需手动配置。

通过定期执行二次登录，可以有效防止会话过期导致的掉线问题，使机器人能够长时间保持在线状态。

## 协议版本适配

插件会自动检测当前使用的协议版本，并根据不同版本选择正确的 API 路径和同步方法：

1. **API 路径适配**：

   - 849 协议：使用`/VXAPI`路径前缀
   - 855/iPad 等协议：使用`/api`路径前缀

2. **同步方法适配**：

   - 849 协议：优先使用 Newinit 接口进行数据同步
   - 855/iPad 等协议：优先使用 sync_message 方法进行数据同步

3. **错误处理**：
   - 当主要同步方法失败时，会自动回退到备用方法
   - 提供详细的错误日志，便于排查问题
